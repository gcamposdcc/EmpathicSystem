package cl.automind.vote.android.view;

import patterns.behavioral.IObserver;
import android.app.Activity;
import android.app.AlertDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.graphics.Color;
import android.graphics.PorterDuff;
import android.graphics.PorterDuffColorFilter;
import android.graphics.drawable.Drawable;
import android.media.MediaPlayer;
import android.os.AsyncTask;
import android.os.Bundle;
import android.os.CountDownTimer;
import android.os.SystemClock;
import android.view.Gravity;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.TextView;
import android.widget.Toast;
import cl.automind.android.vote.R;
import cl.automind.vote.android.application.AppContext;
import cl.automind.vote.command.VoteCastCommand;
import cl.automind.vote.controller.VoteCastController;
import cl.automind.vote.empathy.EmpathicConstants;
import cl.automind.vote.empathy.EmpathyAsyncTask;
import cl.automind.vote.model.Score;
import cl.automind.vote.values.NetworkConstants;
import cl.automind.vote.values.StringConstants;

public class Vote extends Activity {
	public int getLayoutId() {
		return AppContext.VoteState;
	}
	protected void setAsCurrentActivity() {
		AppContext.getInstance().setState(getLayoutId());
		AppContext.getInstance().setActivity(this);
	}
	@Override
	public void onCreate(Bundle savedInstanceState){
		super.onCreate(savedInstanceState);
		setContentView(getLayoutId());
		((TextView)findViewById(R.id.KeyCode)).setText("Presiona para votar");
	}
	@Override
	public void setContentView(int layoutResID){
		super.setContentView(layoutResID);
		setAsCurrentActivity();
	}
	@Override
	protected void onResume() {
		super.onResume();
		setAsCurrentActivity();
	}

	public void viewChoices(View view){
		Intent myIntent = new Intent(view.getContext(), Choices.class);
		startActivity(myIntent);
	}

	MediaPlayer mp;
	public void voteButton(View view){
		new CastVoteThread().execute((Button)view);
	}
	private void clearColors() {
		findViewById(R.id.click0).invalidateDrawable(findViewById(R.id.click0).getBackground());
		findViewById(R.id.click1).invalidateDrawable(findViewById(R.id.click1).getBackground());
		findViewById(R.id.click2).invalidateDrawable(findViewById(R.id.click2).getBackground());
		findViewById(R.id.click3).invalidateDrawable(findViewById(R.id.click3).getBackground());
		findViewById(R.id.click4).invalidateDrawable(findViewById(R.id.click4).getBackground());
		findViewById(R.id.click5).invalidateDrawable(findViewById(R.id.click5).getBackground());
		findViewById(R.id.click0).getBackground().clearColorFilter();
		findViewById(R.id.click1).getBackground().clearColorFilter();
		findViewById(R.id.click2).getBackground().clearColorFilter();
		findViewById(R.id.click3).getBackground().clearColorFilter();
		findViewById(R.id.click4).getBackground().clearColorFilter();
		findViewById(R.id.click5).getBackground().clearColorFilter();
	}
	private void enableButtons(boolean enable){
		findViewById(R.id.click0).setEnabled(enable);
		findViewById(R.id.click1).setEnabled(enable);
		findViewById(R.id.click2).setEnabled(enable);
		findViewById(R.id.click3).setEnabled(enable);
		findViewById(R.id.click4).setEnabled(enable);
		findViewById(R.id.click5).setEnabled(enable);
	}

	private void showEmpathicDialog(Activity activity, String title, String message){

		AlertDialog.Builder builder;
		AlertDialog alertDialog;

		LayoutInflater inflater = activity.getLayoutInflater();
		View layout = inflater.inflate(R.layout.empathic_dialog,
		                               (ViewGroup) activity.findViewById(R.id.emp_dialog_layout_root));

		TextView text = (TextView) layout.findViewById(R.id.emp_dialog_text);
		text.setText(message);
		ImageView image = (ImageView) layout.findViewById(R.id.emp_dialog_image);
		image.setImageResource(R.drawable.icon);

		builder = new AlertDialog.Builder(activity);
		builder = builder.setView(layout);
		builder = builder.setCancelable(false)
			       .setPositiveButton("Me gusta", new DialogInterface.OnClickListener() {
			           public void onClick(DialogInterface dialog, int id) {
			                dialog.cancel();
			           }
			       })
			       .setNegativeButton("No me gusta", new DialogInterface.OnClickListener() {
			           public void onClick(DialogInterface dialog, int id) {
			                dialog.cancel();
			           }
			       });
		alertDialog = builder.create();

		alertDialog.show();
	}

	private void showEmpathicToast(Activity activity, String message){
		LayoutInflater inflater = activity.getLayoutInflater();
		View layout = inflater.inflate(R.layout.empathic_toast,
				(ViewGroup) activity.findViewById(R.id.toast_layout_root));

		ImageView image = (ImageView) layout.findViewById(R.id.emp_toast_image);
		image.setImageResource(R.drawable.icon);
		TextView text = (TextView) layout.findViewById(R.id.emp_toast_text);
		text.setText(message);

		final Toast toast = new Toast(activity.getApplicationContext());
		toast.setGravity(Gravity.BOTTOM, 0, 0);
		toast.setDuration(Toast.LENGTH_LONG);
		toast.setView(layout);
		toast.show();
		new CountDownTimer(9000, 1000)
		{

		    public void onTick(long millisUntilFinished) {toast.show();}
		    public void onFinish() {toast.show();}

		}.start();
	}

	private static int voteCount= 0;
	class CastVoteThread extends AsyncTask<Button, Object, Button> implements IObserver<String>{
		@Override protected void onPreExecute(){
			clearColors();
			enableButtons(false);
		}
		private Button btn;
		@Override protected Button doInBackground(Button... params) {
			btn = params[0];
			try {
				VoteCastController controller = new VoteCastController();
				controller.suscribe(this);
				controller.executeTask(VoteCastCommand.class, new Object[]{ AppContext.getInstance().getKeyCode(), AppContext.getInstance().getRut(), ""+btn.getText().charAt(0)});
			} catch (Exception e) {
				publishProgress(new Object[]{btn, false, StringConstants.VOTE_FAILURE, false});
			}
			return btn;
		}
		@Override protected void onProgressUpdate(Object... params){
			Button button = (Button) params[0];
			Boolean success = (Boolean) params[1];
			String message = (String) params[2];
			Boolean correct = (Boolean) params[3];
			enableButtons(true);
			if (success){
				AppContext.getInstance().getEmpathy().pushValue(EmpathicConstants.DS_SCORES, new Score(voteCount++,correct? 1: 0));
				showEmpathicDialog(this, title, message)
			}
//			new EmpathyAsyncTask().execute(params);
			Drawable d = button.getBackground();
			((TextView)findViewById(R.id.KeyCode)).setText(message);
			PorterDuffColorFilter filter =
				new PorterDuffColorFilter(success.booleanValue() ? (correct.booleanValue()? Color.BLUE: Color.GREEN) : Color.RED, PorterDuff.Mode.SRC_ATOP);
			d.setColorFilter(filter);
		}
		@Override protected void onPostExecute(Button in){
			new VoteClearColorThread().execute(in);
		}
		@Override
		public void onSuscription(String data) {
			// TODO Auto-generated method stub

		}
		@Override
		public void onNew(String data) {
			String message = data;
			String newMess = "";
			boolean success = message.startsWith(""+NetworkConstants.SUCCESS);
			boolean correct = false;
			if (success){
				newMess = StringConstants.VOTE_RECEIVED;
				try{
					String time = message.substring(message.indexOf("R")+1);
					String[] times = time.split(":");
					newMess += " en " + times[0] + " mins, " + times[1] + " segs." ;
					correct = message.charAt(1) == NetworkConstants.VOTE_CORRECT;
				}
				catch (Exception e){
					correct = false;
				}
			} else {
				newMess = StringConstants.VOTE_FAILURE;
				if (message.length() > 1) {
					switch(message.charAt(1)){
					case 'D':
						newMess += " - " + StringConstants.VOTE_DUPLICATED;
						break;
					case 'F':
						newMess += " - " + StringConstants.VOTE_FAILURE;
						break;
					case 'N':
						newMess += " - " + StringConstants.VOTE_NULL;
						break;
					case 'P':
						newMess += " - " + StringConstants.PERMISION_REQUIRED;
						break;
					}
				}
			}
			publishProgress(new Object[]{btn, success, newMess, correct});
		}
		@Override
		public void onCompletition() {
			// TODO Auto-generated method stub

		}
	}
	class VoteClearColorThread extends AsyncTask<Button, Object, Button>{
		@Override protected void onPreExecute(){

		}
		@Override protected Button doInBackground(Button... params) {
			Button btn = params[0];
			return btn;
		}
		@Override protected void onProgressUpdate(Object... params){

		}
		@Override protected void onPostExecute(Button in){
			try{
				new Thread(){
					@Override public void run(){
						SystemClock.sleep(5000);
						clearColors();
						enableButtons(true);
					}
				}.start();
			} catch (Exception e) {
				clearColors();
				enableButtons(true);
			}
		}
	}
}
