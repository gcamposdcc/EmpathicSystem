package cl.automind.empathy;

import java.util.Collection;
import java.util.Set;

import cl.automind.empathy.data.AbstractDataManager;
import cl.automind.empathy.feedback.AbstractEmotion;
import cl.automind.empathy.feedback.AbstractMessage;
import cl.automind.empathy.rule.AbstractArbiter;
import cl.automind.empathy.rule.AbstractRule;
import cl.automind.empathy.rule.AbstractRuleManager;
import cl.automind.empathy.ui.AbstractUiManager;

/**
 * The Core of the Engine, this class is used as a Facade for common
 * engine operation, as such it should not contain any logic but the
 * necesary to make calls to the managers contained in the
 * {@link EmpathicManagers}
 * @author Guillermo
 * @see EmpathicManagers
 */
public abstract class EmpathicKernel {
	
	public EmpathicKernel(){
		loadEmpathy();
		setManagers(new EmpathicManagers());
		startEmpathy();
	}
	// <arbiter>
	private AbstractArbiter arbiter;
	public void setArbiter(AbstractArbiter arbiter) {
		this.arbiter = arbiter;
	}
	public AbstractArbiter getArbiter() {
		return arbiter;
	}
	// </arbiter>
	// <managers>
	private EmpathicManagers managers;
	private void setManagers(EmpathicManagers managers) {
		this.managers = managers;
	}
	protected EmpathicManagers getManagers() {
		return managers;
	}
	// </managers>
	
	
	public void showEmpathy(AbstractMessage message){
		getManagers().getUiManager().displayMessage(message);
	}
	public void showEmpathy(AbstractMessage message, long timeout){
		getManagers().getUiManager().displayMessage(message);
		try { Thread.sleep(timeout); }
		catch (Exception e){ }
		finally { hideEmpathy(); }
	}
	public void hideEmpathy(){
		getManagers().getUiManager().hideCurrentMessage();
	}
	public final void loadEmpathy(){
		Collection<EmpathicPlugin> plugins = loadPluginClasses();
		for (EmpathicPlugin plugin: plugins){
			deployPluginArbiter(plugin);
		}
		for (EmpathicPlugin plugin: plugins){
			deployPluginManagers(plugin);
		}
		for (EmpathicPlugin plugin: plugins){
			deployPluginContent(plugin);
		}
	}
	private final void deployPluginManagers(EmpathicPlugin plugin) {
		AbstractDataManager dataManager = plugin.getDataManager();
		AbstractRuleManager ruleManager = plugin.getRuleManager();
		AbstractUiManager uiManager = plugin.getUiManager();
		getManagers().setDataManager(dataManager);
		getManagers().setRuleManager(ruleManager);
		getManagers().setUiManager(uiManager);
	}
	private final void deployPluginContent(EmpathicPlugin plugin) {
		Collection<AbstractRule> rules = plugin.getRules();
		Collection<AbstractEmotion> emotions = plugin.getEmotions();
		for (AbstractRule rule: rules){
			getManagers().getRuleManager().registerRule(rule.getName(), rule);
		}
	}
	public abstract Collection<EmpathicPlugin> loadPluginClasses();
	public abstract void startEmpathy();
	
	public <T> int pushValue(String DataSourceName, T value){
		return 0;
	}
	
	public AbstractRule getRule(String rulename){
		return getManagers().getRuleManager().getRule(rulename);
	}

	public Set<String> getAllRuleNames(){
		return getManagers().getRuleManager().getAllRulenames();
	}
}
